<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>phylogenetic_ou_regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="phylogenetic_OU_regression_files/libs/clipboard/clipboard.min.js"></script>
<script src="phylogenetic_OU_regression_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="phylogenetic_OU_regression_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="phylogenetic_OU_regression_files/libs/quarto-html/popper.min.js"></script>
<script src="phylogenetic_OU_regression_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="phylogenetic_OU_regression_files/libs/quarto-html/anchor.min.js"></script>
<link href="phylogenetic_OU_regression_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="phylogenetic_OU_regression_files/libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="phylogenetic_OU_regression_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="phylogenetic_OU_regression_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="phylogenetic_OU_regression_files/libs/bootstrap/bootstrap-144d48fe66cc87950839fc7a56aad44d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<section id="running-a-phylogenetic-ou-regression-with-r-and-stan" class="level1">
<h1>Running a Phylogenetic OU Regression with R and Stan</h1>
<p>In this notebook, I will illustrate how one can set up a logistic regression with a phylogenetic random effect following an Ornstein-Uhlenbeck process using R and Stan.</p>
<p>This kind of analysis has conceptual advantages compared with alternatives - such as phylogenetic random effects following a Brownian motion, or correlated evolution using discrete characters and the CTMC model. However, while there are off-the-shelf solutions for the latter two, the OU regression is, to my knowledge, not yet implemented in a dedicated function or package. Such a model can be set up quite easily in Stan, however. This notebook serves to illustrate how this can be done.</p>
<section id="preparing-the-environment" class="level2">
<h2 class="anchored" data-anchor-id="preparing-the-environment">Preparing the environment</h2>
<p>The git repository contains a file <code>OU_logistic_example.yml</code>. You can use it to set up a conda environment containing all the required packages. (Of course you can also install the packages with <code>install.packages</code> if you don’t use conda.) At the command prompt, in the home directory of the repository, do</p>
<pre class="{bash}"><code>conda env create -f OU_logistic_example.yml
conda activate OU_logistic_example</code></pre>
</section>
<section id="loading-the-required-packages" class="level2">
<h2 class="anchored" data-anchor-id="loading-the-required-packages">Loading the required packages</h2>
<div id="cell-1" class="cell" data-scrolled="false" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>({</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(tidyverse)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(rstan)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(parallel)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())  <span class="co"># Enable parallel Stan sampling</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(ape)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(R.utils)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(bridgesampling)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(loo)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(bayesplot)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(codetools)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(ggtree)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(posterior)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(tidybayes)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(ggthemes)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(paletteer)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(ggnewscale)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">options</span>(<span class="at">repr.plot.width =</span> <span class="dv">12</span>, <span class="at">repr.plot.height =</span> <span class="dv">8</span>)  <span class="co"># For base R plots in Jupyter</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">24</span>))  <span class="co"># Increase base font size</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<p>Now let’s get some data. I will use the EDGE tree (Bouckaert 2022).</p>
<div id="cell-3" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data directory if it doesn't exist</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"../data"</span>)) <span class="fu">dir.create</span>(<span class="st">"../data"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the file if it doesn't exist</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>tree_gz <span class="ot">&lt;-</span> <span class="st">"../data/global-language-tree-MCC-labelled.tree.gz"</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>tree_file <span class="ot">&lt;-</span> <span class="st">"../data/global-language-tree-MCC-labelled.tree"</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(tree_file)) {</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">download.file</span>(</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">url =</span> <span class="st">"https://github.com/rbouckaert/global-language-tree-pipeline/releases/download/v1.0.0/global-language-tree-MCC-labelled.tree.gz"</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">destfile =</span> tree_gz,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">mode =</span> <span class="st">"wb"</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    R.utils<span class="sc">::</span><span class="fu">gunzip</span>(tree_gz, <span class="at">destname =</span> tree_file, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove the gzipped file after extraction</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">file.exists</span>(tree_gz)) <span class="fu">file.remove</span>(tree_gz)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>edge_tree <span class="ot">&lt;-</span> <span class="fu">read.nexus</span>(tree_file)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>edge_tree<span class="sc">$</span>tip.label <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">strsplit</span>(edge_tree<span class="sc">$</span>tip.label, <span class="st">"_"</span>), <span class="st">`</span><span class="at">[</span><span class="st">`</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It is advisable to rescale the tree so that the median branch length is 1.</p>
<div id="cell-5" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>edge_tree<span class="sc">$</span>edge.length <span class="ot">&lt;-</span> edge_tree<span class="sc">$</span>edge.length <span class="sc">/</span> (<span class="fu">median</span>(edge_tree<span class="sc">$</span>edge.length))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="grambank-data" class="level2">
<h2 class="anchored" data-anchor-id="grambank-data">Grambank data</h2>
<p>I will look at the somewhat boring feature pair: - GB193: What is the order of adnominal property word and noun? - GB133: Is a pragmatically unmarked constituent order verb-final for transitive clauses?</p>
<p>First we get the grambank data.</p>
<div id="cell-7" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>grambank_file <span class="ot">=</span> <span class="st">"../data/grambank_vals.csv"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(grambank_file)) {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    values_url <span class="ot">&lt;-</span> <span class="st">"https://raw.githubusercontent.com/grambank/grambank/refs/heads/master/cldf/values.csv"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    vals <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(values_url, <span class="at">na =</span> <span class="st">""</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write</span>(vals, grambank_file)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    vals <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(grambank_file)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre><span class="ansi-bold">Rows: </span><span class="ansi-blue-fg">441663</span> <span class="ansi-bold">Columns: </span><span class="ansi-blue-fg">9</span>

<span class="ansi-cyan-fg">──</span> <span class="ansi-bold">Column specification</span> <span class="ansi-cyan-fg">────────────────────────────────────────────────────────</span>

<span class="ansi-bold">Delimiter:</span> ","

<span class="ansi-red-fg">chr</span> (9): ID, Language_ID, Parameter_ID, Value, Code_ID, Comment, Source, Sou...



<span class="ansi-cyan-fg">ℹ</span> Use `spec()` to retrieve the full column specification for this data.

<span class="ansi-cyan-fg">ℹ</span> Specify the column types or set `show_col_types = FALSE` to quiet this message.
</pre>
</div>
</div>
</div>
<p>Now we filter out the datapoints for the two parameters of interest and the languages in the tree. I only consider two values per parameter, and only languages having a relevant value for both parameters.</p>
<div id="cell-9" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> vals <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Language_ID <span class="sc">%in%</span> edge_tree<span class="sc">$</span>tip.label) <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter_ID <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"GB193"</span>, <span class="st">"GB133"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Language_ID, Parameter_ID, Value) <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Value <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Value =</span> <span class="fu">as.numeric</span>(Value)) <span class="sc">%&gt;%</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Parameter_ID, <span class="at">values_from =</span> Value) <span class="sc">%&gt;%</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(GB193 <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we prune the tree to only include the languages in the data.</p>
<div id="cell-11" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>pruned_tree <span class="ot">&lt;-</span> <span class="fu">drop.tip</span>(edge_tree, <span class="fu">setdiff</span>(edge_tree<span class="sc">$</span>tip.label, d<span class="sc">$</span>Language_ID))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Check that d$Language_ID and pruned_tree$tip.label are the same set</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">setequal</span>(d<span class="sc">$</span>Language_ID, pruned_tree<span class="sc">$</span>tip.label)) {</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Mismatch between d$Language_ID and pruned_tree$tip.label"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">setdiff</span>(d<span class="sc">$</span>Language_ID, pruned_tree<span class="sc">$</span>tip.label))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">setdiff</span>(pruned_tree<span class="sc">$</span>tip.label, d<span class="sc">$</span>Language_ID))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"d$Language_ID and pruned_tree$tip.label match."</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>d$Language_ID and pruned_tree$tip.label match.
</code></pre>
</div>
</div>
<p>Now the rows in <code>d</code> are rearranged to match the order of the tips in the pruned tree.</p>
<div id="cell-13" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d[<span class="fu">match</span>(pruned_tree<span class="sc">$</span>tip.label, d<span class="sc">$</span>Language_ID), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally we convert the features to numeric values, and convert to 0/1</p>
<div id="cell-15" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> GB193 <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> GB133 </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s have a look at the tree and the data.</p>
<p>For now, I keep the data set small and restrict myself to 100 taxa.</p>
<div id="cell-17" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># You can replace 123 with any integer</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d[<span class="fu">sample</span>(<span class="fu">nrow</span>(d), <span class="dv">100</span>), ]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>pruned_tree <span class="ot">&lt;-</span> <span class="fu">drop.tip</span>(pruned_tree, <span class="fu">setdiff</span>(pruned_tree<span class="sc">$</span>tip.label, d<span class="sc">$</span>Language_ID))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d[<span class="fu">match</span>(pruned_tree<span class="sc">$</span>tip.label, d<span class="sc">$</span>Language_ID), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-18" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtree</span>(pruned_tree, <span class="at">layout=</span><span class="st">"circular"</span>) <span class="sc">+</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tree</span>() <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tiplab</span>() <span class="sc">+</span>            <span class="co"># Adds tip labels</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_tree2</span>()              <span class="co"># Adds scale axis (x-axis for branch lengths)</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>d <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A tibble: 10 × 5</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">Language_ID</th>
<th data-quarto-table-cell-role="th" scope="col">GB133</th>
<th data-quarto-table-cell-role="th" scope="col">GB193</th>
<th data-quarto-table-cell-role="th" scope="col">x</th>
<th data-quarto-table-cell-role="th" scope="col">y</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>adan1251</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td>ajas1235</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>alab1254</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td>alya1239</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td>arch1244</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td>aree1239</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td>arig1246</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>awar1249</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td>band1344</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>bayb1234</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="phylogenetic_OU_regression_files/figure-html/cell-11-output-2.png" width="720" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="stan-model" class="level2">
<h2 class="anchored" data-anchor-id="stan-model">Stan model</h2>
<p>The tree is represented as a phylo object in <code>ape</code>, which is suitable for Stan.</p>
<p>Just to be on the safe side, we make sure that the branches are in postorder.</p>
<div id="cell-20" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>pruned_tree <span class="ot">&lt;-</span> <span class="fu">reorder</span>(pruned_tree, <span class="st">"postorder"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we code the tree and the data as a data list.</p>
<div id="cell-22" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">nrow</span>(d),  <span class="co"># Number of languages</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">Nnodes =</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">as.vector</span>(pruned_tree<span class="sc">$</span>edge))),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">root_node =</span> <span class="fu">length</span>(pruned_tree<span class="sc">$</span>tip.label) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> d<span class="sc">$</span>x,  <span class="co"># Predictor variable (numeral-noun order)</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> d<span class="sc">$</span>y,  <span class="co"># Response variable (adnominal demonstrative-noun order)</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Nedges =</span> <span class="fu">nrow</span>(pruned_tree<span class="sc">$</span>edge), <span class="co"># number of edges</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">edges =</span> pruned_tree<span class="sc">$</span>edge,  <span class="co"># Edges of the tree,</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">edge_lengths =</span> pruned_tree<span class="sc">$</span>edge.length  <span class="co"># Lengths of the edges</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="vanilla-logistic-regression" class="level3">
<h3 class="anchored" data-anchor-id="vanilla-logistic-regression">Vanilla logistic regression</h3>
<p>We start with a simple logistic regression without any phylogenetic effects, just to see how it works.</p>
<p>The model formula is:</p>
<p><span class="math display">\[
\begin{align}
\alpha &amp;\sim \mathcal N(0, 10)\\
\beta &amp;\sim \mathcal N(0, 10)\\
y &amp;\sim \text{Bernoulli}(\text{logit}^{-1}(\alpha + \beta x))
\end{align}
\]</span></p>
<p>Let’s run this in Stan.</p>
<div id="cell-24" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>stan_code_vanilla <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; N;                      // Number of observations</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="st">    vector&lt;lower=0, upper=1&gt;[N] x;       // Predictor variable</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int&lt;lower=0,upper=1&gt; y;     // Response variable (binary)</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="st">    real alpha;      // Intercept</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="st">    real beta;       // Slope</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="st">    // Priors</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha ~ normal(0, 10);</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="st">    beta ~ normal(0, 10);</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="st">    // Likelihood</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="st">    y ~ bernoulli_logit(alpha + beta * x);</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[N] log_lik;</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="st">    for (n in 1:N) {</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="st">        log_lik[n] = bernoulli_logit_lpmf(y[n] | alpha + beta * x[n]);</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>stan_model_vanilla <span class="ot">&lt;-</span> <span class="fu">stan_model</span>(<span class="at">model_code =</span> stan_code_vanilla)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-25" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>fit_vanilla <span class="ot">&lt;-</span> <span class="fu">sampling</span>(stan_model_vanilla, <span class="at">data =</span> stan_data, <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">chains =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-26" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit_vanilla, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

       mean se_mean   sd  2.5%   25%  50%   75% 97.5% n_eff Rhat
alpha  0.29    0.01 0.39 -0.48  0.03  0.3  0.55  1.03   918    1
beta  -1.09    0.02 0.48 -2.02 -1.41 -1.1 -0.76 -0.15   884    1

Samples were drawn using NUTS(diag_e) at Sat Jun 14 19:37:19 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<div id="cell-27" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>(fit_vanilla),</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars=</span><span class="st">"beta"</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob =</span> <span class="fl">0.95</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="phylogenetic_OU_regression_files/figure-html/cell-17-output-1.png" width="720" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The posterior distribution of the slope <span class="math inline">\(\beta\)</span> does not include zero, indicating that there is a significant relationship between the predictor variable <code>x</code> and the response variable <code>y</code>. The direction is negative, meaning that N-ANM order disfavors OV order.</p>
<p>For model comparison, we can use the <code>bridgesampling</code> package to compute the log marginal likelihood.</p>
<div id="cell-29" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">capture.output</span>({</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  log_marginal_likelihood_vanilla_regression <span class="ot">&lt;-</span> <span class="fu">bridge_sampler</span>(fit_vanilla)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>}, <span class="at">file =</span> <span class="st">"/dev/null"</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(log_marginal_likelihood_vanilla_regression)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bridge sampling estimate of the log marginal likelihood: -64.61308
Estimate obtained in 5 iteration(s) via method "normal".</code></pre>
</div>
</div>
</section>
<section id="vanilla-logistic-correlation-study" class="level3">
<h3 class="anchored" data-anchor-id="vanilla-logistic-correlation-study">Vanilla logistic correlation study</h3>
<p>A regression model assumes an asymmetry between the predictor variable (which is not modeled) and the response variabel (which is modeled). This is not really justified in observational studies where we have not control over the predictor variable. A more appropriate model is one where both variables are generated by some stochastic process.</p>
<p>This can be modeled as follows:</p>
<p><span class="math display">\[  
\begin{align}
z &amp;\sim \mathcal N(\mu, R)\\
R &amp;\sim \text{LKJ}(2)\\
\mu &amp;= \mathcal N(\mathbf 0, 5\mathbf I)\\
x &amp;\sim \text{Bernoulli}(\text{logit}^{-1}(z_1))\\
y &amp;\sim \text{Bernoulli}(\text{logit}^{-1}(z_2))
\end{align}
\]</span></p>
<p>Here <span class="math inline">\(z\)</span> is a bivariate normal variable with mean <span class="math inline">\(\mu\)</span> and covariance <span class="math inline">\(R\)</span>. The two components of <span class="math inline">\(z\)</span> have standard deviations 1, and the correlation between them is given by <span class="math inline">\(\rho = R_{12} = R_{21}\)</span>. The correlation matrix is generated from a uniform distribution distribution, which is a flexible way to model correlations. The two variables <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> are then generated from the first and second components of <span class="math inline">\(z\)</span>, respectively, using the logistic function.</p>
<p>The interesting question is then whether the correlation between <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>, i.e., <span class="math inline">\(\rho = r_{21}\)</span>, is significantly different from zero. If it is, this indicates that there is a significant correlation between the two variables, which is what we are interested in.</p>
<div id="cell-31" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>stan_code_vanilla_corr <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; N;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0, upper=1&gt; x;       // first binary variable</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0, upper=1&gt; y;       // second binary variable</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[2] mu;                          // Mean of latent variables</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] L_R;           // Cholesky factor of correlation matrix</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[2, N] z_raw;                    // Standard normal latent variables</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="st">  real rho = L_R[2, 1];                  // Extract the correlation coefficient from the Cholesky factor</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[2, N] z;                        // Latent variables with correlation</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="st">  z = rep_matrix(mu, N) + L_R * z_raw;   // Transform raw latent variables to correlated latent variables</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="st">  // Priors</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="st">  mu ~ normal(0, 5);                       // Prior for the mean of latent variables</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="st">  L_R ~ lkj_corr_cholesky(2);              // Prior for the Cholesky factor of the correlation matrix</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(z_raw) ~ normal(0, 1);         // standard normal prior for latent</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="st">  // Likelihood</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N) {</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="st">    x[n] ~ bernoulli_logit(z[1, n]);</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="st">    y[n] ~ bernoulli_logit(z[2, n]);</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] log_lik_x;</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] log_lik_y;</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N) {</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="st">    log_lik_x[n] = bernoulli_logit_lpmf(x[n] | z[1, n]);</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="st">    log_lik_y[n] = bernoulli_logit_lpmf(y[n] | z[2, n]);</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>stan_model_vanilla_corr <span class="ot">&lt;-</span> <span class="fu">stan_model</span>(<span class="at">model_code =</span> stan_code_vanilla_corr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-32" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>fit_vanilla_corr <span class="ot">&lt;-</span> <span class="fu">sampling</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    stan_model_vanilla_corr,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> stan_data,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.95</span>, <span class="at">max_treedepth =</span> <span class="dv">15</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-33" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit_vanilla_corr, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"mu"</span>, <span class="st">"rho"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

       mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
mu[1]  1.02    0.00 0.25  0.51  0.86  1.02  1.19  1.51  4770    1
mu[2] -0.55    0.00 0.26 -1.06 -0.73 -0.55 -0.37 -0.05  3945    1
rho   -0.48    0.01 0.31 -0.93 -0.72 -0.53 -0.29  0.23  1219    1

Samples were drawn using NUTS(diag_e) at Sat Jun 14 19:40:32 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<div id="cell-34" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>(fit_vanilla_corr),</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="st">"rho"</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob =</span> <span class="fl">0.95</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="phylogenetic_OU_regression_files/figure-html/cell-22-output-1.png" width="720" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The posterior of <span class="math inline">\(\rho\)</span> includes 0, so no clear evidence for a correlation.</p>
<p>We compute the log marginal likelihood for this model for later use.</p>
<div id="cell-36" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">capture.output</span>({</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    log_marginal_likelihood_vanilla_corr <span class="ot">&lt;-</span> <span class="fu">bridge_sampler</span>(fit_vanilla_corr)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>}, <span class="at">file =</span> <span class="st">"/dev/null"</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(log_marginal_likelihood_vanilla_corr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bridge sampling estimate of the log marginal likelihood: 56.08678
Estimate obtained in 7 iteration(s) via method "normal".</code></pre>
</div>
</div>
<p>A direct model comparison via Bayes Factor is not possible because the regression model models the distribution of <code>x</code> given <code>y</code>, while the correlation models the joint distribution. However, we can apply Pareto-smoothed leave one out cross-validation if we marginalize over <code>x</code> in the correlation model.</p>
<div id="cell-38" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract log-likelihood matrix: draws x observations</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>log_lik1 <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(fit_vanilla, <span class="at">parameter_name =</span> <span class="st">"log_lik"</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>log_lik2 <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(fit_vanilla_corr, <span class="at">parameter_name =</span> <span class="st">"log_lik_y"</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># compute LOO</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>loo1 <span class="ot">&lt;-</span> <span class="fu">loo</span>(log_lik1)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>loo2 <span class="ot">&lt;-</span> <span class="fu">loo</span>(log_lik2)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># compare</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(loo1, loo2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A compare.loo: 2 × 8 of type dbl</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">elpd_diff</th>
<th data-quarto-table-cell-role="th" scope="col">se_diff</th>
<th data-quarto-table-cell-role="th" scope="col">elpd_loo</th>
<th data-quarto-table-cell-role="th" scope="col">se_elpd_loo</th>
<th data-quarto-table-cell-role="th" scope="col">p_loo</th>
<th data-quarto-table-cell-role="th" scope="col">se_p_loo</th>
<th data-quarto-table-cell-role="th" scope="col">looic</th>
<th data-quarto-table-cell-role="th" scope="col">se_looic</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">model1</td>
<td>0.0000000</td>
<td>0.000000</td>
<td>-66.28474</td>
<td>3.308107</td>
<td>2.182711</td>
<td>0.1591767</td>
<td>132.5695</td>
<td>6.616215</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">model2</td>
<td>-0.6029132</td>
<td>1.708781</td>
<td>-66.88765</td>
<td>2.359000</td>
<td>15.812923</td>
<td>0.7208897</td>
<td>133.7753</td>
<td>4.718001</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>So the regression model is slightly preferred, but the difference is almost indistinguishable from zero.</p>
</section>
<section id="the-ornstein-uhlenbeck-process" class="level3">
<h3 class="anchored" data-anchor-id="the-ornstein-uhlenbeck-process">The Ornstein-Uhlenbeck process</h3>
<p>The OU process is a stochastic process, similar to Brownian motion. The crucial difference is that OU is <code>random walk on a leash</code>. Technically, it is the mixture of a stochastic Brownian motion process and a deterministic trajectory exponentially converging to a mean value. It is characterized by the following distribution: <span class="math display">\[
X_t \sim \mathcal N\left(x_0e^{-\lambda t} + \mu (1-e^{-\lambda t}), \frac{\sigma}{\sqrt{2\lambda}}\sqrt{1-e^{-2\lambda t}}\right)
\]</span></p>
<p>The parameters are:</p>
<ul>
<li><span class="math inline">\(x_0\)</span>: the initial value of the process</li>
<li><span class="math inline">\(\mu\)</span>: the mean value to which the process converges</li>
<li><span class="math inline">\(\lambda\)</span>: the rate of convergence to the mean value</li>
<li><span class="math inline">\(\sigma\)</span>: the volatility of the process</li>
<li><span class="math inline">\(t\)</span>: the time at which the process is evaluated</li>
</ul>
<p>The long-term equilibrium distribution is: <span class="math display">\[
X_t \sim \mathcal N(\mu, \frac{\sigma}{\sqrt{2\lambda}})
\]</span></p>
</section>
</section>
<section id="logistic-regression-with-a-phylogenetic-random-effect" class="level2">
<h2 class="anchored" data-anchor-id="logistic-regression-with-a-phylogenetic-random-effect">Logistic regression with a phylogenetic random effect</h2>
<p>We now add a phylogenetic random effect to the logistic regression from above:</p>
<p><span class="math display">\[
\begin{align}
\alpha &amp;\sim \mathcal N(0, 10)\\
\beta &amp;\sim \mathcal N(0, 10)\\
\epsilon &amp;\sim \mathcal N(0, \Sigma)\\
y &amp;\sim \text{Bernoulli}(\text{logit}^{-1}(\alpha + \beta x + \epsilon))
\end{align}
\]</span></p>
<p>The covariance matrix <span class="math inline">\(\Sigma\)</span> of the phylogenetic random effect is given by</p>
<p><span class="math display">\[
\Sigma_{ij} = \frac{\sigma^2}{2\lambda} e^{-\lambda t_{ij}},
\]</span></p>
<p>where <span class="math inline">\(t_{ij}\)</span> is the patristic distance between language <span class="math inline">\(i\)</span> and language <span class="math inline">\(j\)</span> in the phylogeny.</p>
<p>A direct implementation of this formula in Stan is possible but inefficient. A better approach directly simulates the evolution of the latent variable <span class="math inline">\(\epsilon\)</span> along the phylgeny. This means that <span class="math inline">\(\epsilon\)</span> has a value not only at the tips but also at the internal nodes. The value at the root is sampled from the equilibrium distribution, and the value of the other nodes is drawn from the equation above, repeated here:</p>
<p><span class="math display">\[
X_t \sim \mathcal N(x_0e^{-\lambda t} + \mu (1-e^{-\lambda t}), \frac{\sigma^2}{2\lambda}(1-e^{-2\lambda t})).
\]</span></p>
<p><span class="math inline">\(X_t\)</span> is now the value at the daughter node, <span class="math inline">\(x_0\)</span> at the mother node, and <span class="math inline">\(t\)</span> is the branch length.</p>
<div id="cell-40" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="31">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>stan_model_code_OU_regression <span class="ot">=</span> <span class="st">"</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N;                                         // number of tips with data</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; Nnodes;                                    // total number of nodes</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; Nedges;                                    // number of edges in the tree</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper=1&gt;[N] x;                          // predictor at tips</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0, upper=1&gt; y;                       // binary response at tips</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="st">  array[Nedges, 2] int&lt;lower=1, upper=Nnodes&gt; edges;      // parent → child</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[Nedges] edge_lengths;                   // edge lengths</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1, upper=Nnodes&gt; root_node;                   // index of root node</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Nnodes] z_std;       // standard normal reparam for latent z</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;        // OU diffusion</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; lambda;       // OU strength</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real mu;                    // OU mean</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha;                 // intercept</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta;                  // slope</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Nnodes] z;</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="st">  // root node</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="st">  z[root_node] = mu + (sigma / sqrt(2 * lambda)) * z_std[root_node];</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a><span class="st">  // recursive evolution</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a><span class="st">  for (e in 1:Nedges) {</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a><span class="st">    int edge_index = Nedges - e + 1; // reverse order for recursion</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a><span class="st">    int parent = edges[edge_index, 1];</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a><span class="st">    int child = edges[edge_index, 2];</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a><span class="st">    real len = edge_lengths[edge_index];</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="st">    real decay = exp(-lambda * len);</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="st">    real s = sigma * sqrt(-expm1(-2 * lambda * len) / (2 * lambda));</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a><span class="st">    real mn = mu + (z[parent] - mu) * decay;</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a><span class="st">    z[child] = mn + s * z_std[child];</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a><span class="st">  // Priors</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha ~ normal(0, 10);</span></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a><span class="st">  beta ~ normal(0, 10);</span></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ lognormal(0, 1);</span></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a><span class="st">  lambda ~ lognormal(0, 1);</span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a><span class="st">  mu ~ normal(0, 2);</span></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a><span class="st">  z_std ~ normal(0, 1);  // standard normal prior</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a><span class="st">  // Likelihood</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a><span class="st">    y[i] ~ bernoulli_logit(alpha + beta * x[i] + z[i]);</span></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] log_lik;</span></span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a><span class="st">    log_lik[i] = bernoulli_logit_lpmf(y[i] | alpha + beta * x[i] + z[i]);</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>stan_model_OU_regression <span class="ot">&lt;-</span> <span class="fu">stan_model</span>(<span class="at">model_code =</span> stan_model_code_OU_regression)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-41" class="cell" data-scrolled="false" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>fit_OU_regression <span class="ot">&lt;-</span> <span class="fu">sampling</span>(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    stan_model_OU_regression,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> stan_data,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.95</span>, <span class="at">max_treedepth =</span> <span class="dv">15</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-42" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit_OU_regression, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"mu"</span>, <span class="st">"sigma"</span>, <span class="st">"lambda"</span>, <span class="st">"alpha"</span>, <span class="st">"beta"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

        mean se_mean   sd   2.5%   25%   50%  75% 97.5% n_eff Rhat
mu      0.15    0.03 2.00  -3.70 -1.16  0.14 1.50  4.16  3853 1.00
sigma   6.80    0.58 8.04   1.24  2.94  4.75 7.84 23.58   189 1.02
lambda  0.05    0.00 0.02   0.02  0.03  0.04 0.06  0.09  1360 1.00
alpha   3.70    0.12 5.00  -5.72  0.54  3.33 6.57 14.79  1644 1.00
beta   -2.68    0.13 4.90 -13.25 -5.28 -2.44 0.03  7.21  1512 1.00

Samples were drawn using NUTS(diag_e) at Sat Jun 14 19:48:22 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<div id="cell-43" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>(fit_OU_regression),</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="st">"beta"</span>,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob =</span> <span class="fl">0.95</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="phylogenetic_OU_regression_files/figure-html/cell-28-output-1.png" width="720" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-44" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">capture.output</span>({</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    log_marginal_likelihood_OU_regression <span class="ot">&lt;-</span> <span class="fu">bridge_sampler</span>(fit_OU_regression)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>}, <span class="at">file =</span> <span class="st">"/dev/null"</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(log_marginal_likelihood_OU_regression)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bridge sampling estimate of the log marginal likelihood: 131.8683
Estimate obtained in 22 iteration(s) via method "normal".</code></pre>
</div>
</div>
<p>Now we can compute the Bayes factor between the vanilla regression and the OU phylogenetic regression.</p>
<div id="cell-46" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>log_marginal_likelihood_OU_regression<span class="sc">$</span>logml <span class="sc">-</span> log_marginal_likelihood_vanilla_regression<span class="sc">$</span>logml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
196.481345778698
</div>
</div>
<p>This is extremely strong evidence in favor of the OU model.</p>
<p>The HPD for <span class="math inline">\(\beta\)</span> is very broad and includes 0. So there is no evidence for the significant effect of the order of adnominal property words on verb position.</p>
<p>However, I find it hard to wrap my mind around what such a model actually means. It says that there is a latent variable <span class="math inline">\(\epsilon\)</span> evolving along the tree, and the probability of a language being verb final depends both on this latent variable and on the order of adjective-noun.</p>
<p>A more realistic model, it seems to me, is one where there are</p>
<ul>
<li>a latent variable determining adjective-noun order, and</li>
<li>a latent variable determining verb position.</li>
</ul>
<p>These latent variables evolve simultaneously along the tree. If there is a dependency between the two observed variables resulting from diachronic processes, there is a correlation between the diachronic changes of the variables.</p>
<p>This can be implemented in an extension of the bivariate correlation model used above.</p>
<p>The model specification is as follows, where <span class="math inline">\(N\)</span> is the number of languages, and <span class="math inline">\(t_{l_1, l_2}\)</span> is the length of from the root of the tree to the most recent common ancestor of <span class="math inline">\(l_1\)</span> and <span class="math inline">\(l_2\)</span>:</p>
<p><span class="math display">\[  
\begin{align}
R &amp;\sim \text{LKJ}(2)\\
\Sigma_{(l_1, k_1), (l_2, k_2)} &amp;= R_{k_1, k_2}\cdot \frac{\sigma_{k_1}\sigma_{k_2}}{\lambda_{k_1}+\lambda_{k_2}}\left(1-e^{-(\lambda_{k_1}+\lambda_{k_2})t_{l_1, l_2}}\right)
\\
\mu_i &amp;= \mathcal N(\mathbf 0, 2)\\
\sigma_i &amp;= \text{Lognormal}(0,1)\\
\lambda_i &amp;= \text{Lognormal}(0,1)\\
z &amp;\sim \mathcal N(\text{repeat}(\mu, N), \Sigma)\\
x_i &amp;\sim \text{Bernoulli}(\text{logit}^{-1}(z_{i,1}))\\
y_i &amp;\sim \text{Bernoulli}(\text{logit}^{-1}(z_{i,2}))
\end{align}
\]</span></p>
<div id="cell-48" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="46">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>stan_code_OU_correlation <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N;                                        // number of tips with data</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; Nnodes;                                   // total number of nodes</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; Nedges;                                   // number of edges in the tree</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0, upper=1&gt; x;                      // first binary response</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0, upper=1&gt; y;                      // second binary response</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="st">  array[Nedges, 2] int&lt;lower=1, upper=Nnodes&gt; edges;     // parent → child</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[Nedges] edge_lengths;                  // edge lengths</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1, upper=Nnodes&gt; root_node;                  // index of root node</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Nnodes, 2] z_std;                   // standard-normal latent variables</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] sigma;                  // OU diffusion parameters</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] lambda;                 // OU pull strengths</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[2] mu;                              // OU stationary means</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] L_std;             // Cholesky factor of correlation matrix</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Nnodes, 2] z;     // latent values</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="st">  real rho = L_std[2, 1];  // correlation coefficient</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a><span class="st">  // Root node, drawn from OU stationary distribution</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="st">  z[root_node] = (mu + (sigma ./ sqrt(2 * lambda)) .* (L_std * to_vector(z_std[root_node])))';</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a><span class="st">  // Recursive evolution</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a><span class="st">  for (e in 1:Nedges) {</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a><span class="st">    int edge_index = Nedges - e + 1;   // reverse order for recursion, root to tips</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a><span class="st">    int parent = edges[edge_index, 1];</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a><span class="st">    int child  = edges[edge_index, 2];</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a><span class="st">    real len = edge_lengths[edge_index];</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a><span class="st">    // Vectorized decay and scale</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[2] decay = exp(-lambda * len);</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[2] s = sigma .* sqrt(-expm1(-2 * lambda * len) ./ (2 * lambda));</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[2] mean = mu + (to_vector(z[parent]) - mu) .* decay;</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[2] eps  = L_std * z_std[child]';</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a><span class="st">    z[child] = (mean + s .* eps)';</span></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a><span class="st">  // Priors</span></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ lognormal(0, 1);</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a><span class="st">  lambda ~ lognormal(0, 1);</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a><span class="st">  mu ~ normal(0, 2);</span></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a><span class="st">  L_std ~ lkj_corr_cholesky(2.0);</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(z_std) ~ normal(0, 1);</span></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a><span class="st">  // Likelihood</span></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a><span class="st">    x[i] ~ bernoulli_logit(z[i, 1]);</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a><span class="st">    y[i] ~ bernoulli_logit(z[i, 2]);</span></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[N] log_lik_x;</span></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[N] log_lik_y;</span></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a><span class="st">    for (i in 1:N) {</span></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a><span class="st">        log_lik_x[i] = bernoulli_logit_lpmf(x[i] | z[i, 1]);</span></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a><span class="st">        log_lik_y[i] = bernoulli_logit_lpmf(y[i] | z[i, 2]);</span></span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>stan_model_OU_correlation <span class="ot">&lt;-</span> <span class="fu">stan_model</span>(<span class="at">model_code =</span> stan_code_OU_correlation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-49" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="47">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>fit_OU_correlation <span class="ot">&lt;-</span> <span class="fu">sampling</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    stan_model_OU_correlation,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> stan_data,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.95</span>, <span class="at">max_treedepth =</span> <span class="dv">15</span>)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-50" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="48">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit_OU_correlation, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">"mu"</span>, <span class="st">"sigma"</span>, <span class="st">"lambda"</span>, <span class="st">"rho"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=10000; warmup=5000; thin=10; 
post-warmup draws per chain=500, total post-warmup draws=2000.

           mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
mu[1]      1.86    0.03 1.08  0.25  1.11  1.71  2.47  4.29  1538    1
mu[2]      0.63    0.03 1.36 -2.15 -0.16  0.57  1.46  3.42  1726    1
sigma[1]   2.23    0.04 1.69  0.42  1.20  1.85  2.77  6.16  1647    1
sigma[2]   3.69    0.09 3.31  0.73  1.71  2.72  4.50 13.10  1439    1
lambda[1]  0.26    0.03 0.82  0.03  0.06  0.09  0.14  2.16  1069    1
lambda[2]  0.05    0.00 0.02  0.02  0.03  0.05  0.06  0.09  1975    1
rho       -0.27    0.01 0.22 -0.67 -0.42 -0.28 -0.14  0.19  1149    1

Samples were drawn using NUTS(diag_e) at Sat Jun 14 20:08:52 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<div id="cell-51" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="49">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>(fit_OU_correlation),</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="st">"rho"</span>,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob =</span> <span class="fl">0.95</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="phylogenetic_OU_regression_files/figure-html/cell-34-output-1.png" width="720" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Since the HPD of <span class="math inline">\(\rho\)</span> includes 0, we conclude that there is no credible evidence for a diachronic correlation between the two variables.</p>
<p>Bayes factor:</p>
<div id="cell-53" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="50">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">capture.output</span>({</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    log_marginal_likelihood_OU_correlation <span class="ot">&lt;-</span> <span class="fu">bridge_sampler</span>(fit_OU_correlation, <span class="at">silent =</span> <span class="cn">TRUE</span>, <span class="at">maxiter =</span> <span class="dv">10000</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>}, <span class="at">file =</span> <span class="st">"/dev/null"</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(log_marginal_likelihood_OU_correlation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“logml could not be estimated within maxiter, rerunning with adjusted starting value. 
Estimate might be more variable than usual.”</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Bridge sampling estimate of the log marginal likelihood: 258.3218
Estimate obtained in 10001 iteration(s) via method "normal".</code></pre>
</div>
</div>
<div id="cell-54" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="51">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>log_marginal_likelihood_OU_correlation<span class="sc">$</span>logml <span class="sc">-</span> log_marginal_likelihood_vanilla_corr<span class="sc">$</span>logml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
202.235031826148
</div>
</div>
<p>Again we find overwhelming evidence in favor of the phylogenetic model.</p>
<p>We can complement model comparison via Bayes Factor with Pareto-smoothed leave-one-out cross-validation.</p>
<div id="cell-56" class="cell" data-scrolled="true" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="53">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract log-likelihood matrix: draws x observations</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>log_lik1 <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(fit_vanilla, <span class="at">parameter_name =</span> <span class="st">"log_lik"</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>log_lik2 <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(fit_vanilla_corr, <span class="at">parameter_name =</span> <span class="st">"log_lik_y"</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>log_lik3 <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(fit_OU_regression, <span class="at">parameter_name =</span> <span class="st">"log_lik"</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>log_lik4 <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(fit_OU_correlation, <span class="at">parameter_name =</span> <span class="st">"log_lik_y"</span>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co"># compute LOO</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>loo1 <span class="ot">&lt;-</span> <span class="fu">loo</span>(log_lik1)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>loo2 <span class="ot">&lt;-</span> <span class="fu">loo</span>(log_lik2)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>loo3 <span class="ot">&lt;-</span> <span class="fu">loo</span>(log_lik3)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>loo4 <span class="ot">&lt;-</span> <span class="fu">loo</span>(log_lik4)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="co"># compare</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(loo1, loo2, loo3, loo4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.
”
Warning message:
“Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.
”</code></pre>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A compare.loo: 4 × 8 of type dbl</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">elpd_diff</th>
<th data-quarto-table-cell-role="th" scope="col">se_diff</th>
<th data-quarto-table-cell-role="th" scope="col">elpd_loo</th>
<th data-quarto-table-cell-role="th" scope="col">se_elpd_loo</th>
<th data-quarto-table-cell-role="th" scope="col">p_loo</th>
<th data-quarto-table-cell-role="th" scope="col">se_p_loo</th>
<th data-quarto-table-cell-role="th" scope="col">looic</th>
<th data-quarto-table-cell-role="th" scope="col">se_looic</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">model3</td>
<td>0.000000</td>
<td>0.000000</td>
<td>-21.76012</td>
<td>2.301218</td>
<td>17.109394</td>
<td>1.9788649</td>
<td>43.52024</td>
<td>4.602435</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">model4</td>
<td>-7.389789</td>
<td>1.179653</td>
<td>-29.14991</td>
<td>3.197381</td>
<td>21.300111</td>
<td>2.6327950</td>
<td>58.29982</td>
<td>6.394762</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">model1</td>
<td>-44.524619</td>
<td>3.102177</td>
<td>-66.28474</td>
<td>3.308107</td>
<td>2.182711</td>
<td>0.1591767</td>
<td>132.56948</td>
<td>6.616215</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">model2</td>
<td>-45.127532</td>
<td>2.562491</td>
<td>-66.88765</td>
<td>2.359000</td>
<td>15.812923</td>
<td>0.7208897</td>
<td>133.77531</td>
<td>4.718001</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The two phylogenetic models perform massively better than the vanilla models. Furthermore if our goal is to predict the verb position of an unseen language from its noun-adjective order and its position in the tree, the regression model is superior to the correlation model.</p>
<p>As a nice side effect of the explicit modeling of the diachronic histories, we can plot the posterior means of the latent variables at the internal nodes, thereby visualizing the evolution of the latent variables.</p>
<div id="cell-58" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="59">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>posterior_df <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit_OU_correlation)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>z_posterior <span class="ot">&lt;-</span> posterior_df <span class="sc">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(z[i, j]) <span class="sc">%&gt;%</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(i, j) <span class="sc">%&gt;%</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_z =</span> <span class="fu">mean</span>(z), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>z_adjective <span class="ot">&lt;-</span> z_posterior <span class="sc">%&gt;%</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(j <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(mean_z)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>z_vo <span class="ot">&lt;-</span> z_posterior <span class="sc">%&gt;%</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(j <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(mean_z)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>pruned_tree<span class="sc">$</span>node.label <span class="ot">&lt;-</span> <span class="fu">as.character</span>(</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">length</span>(pruned_tree<span class="sc">$</span>tip.label) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="fu">length</span>(pruned_tree<span class="sc">$</span>tip.label) <span class="sc">+</span> pruned_tree<span class="sc">$</span>Nnode)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>tree_plot <span class="ot">&lt;-</span> <span class="fu">ggtree</span>(pruned_tree)</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>tree_info <span class="ot">&lt;-</span> tree_plot<span class="sc">$</span>data</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>tree_info<span class="sc">$</span>node.label <span class="ot">&lt;-</span> <span class="fu">as.character</span>(tree_info<span class="sc">$</span>label)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-59" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="60">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(tree_info)) {</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (tree_info<span class="sc">$</span>isTip[i]) {</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If it's a tip, get the corresponding Glottocode</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>        glottocode <span class="ot">&lt;-</span> tree_info<span class="sc">$</span>label[i]</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find the index of the Glottocode in d_ie</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>        index <span class="ot">&lt;-</span> <span class="fu">which</span>(pruned_tree<span class="sc">$</span>tip.label <span class="sc">==</span> glottocode)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign the Affix value to the node label</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>        tree_info<span class="sc">$</span>node.label[i] <span class="ot">&lt;-</span> index</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If it's not a tip, copy label</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>        tree_info<span class="sc">$</span>node.label[i] <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(tree_info<span class="sc">$</span>node.label[i])</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>node_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">node.label =</span> <span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(z_adjective)),</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_adjective =</span> z_adjective,</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_vo =</span> z_vo</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>tree_data <span class="ot">&lt;-</span> tree_info <span class="sc">%&gt;%</span></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(node_data, <span class="at">by =</span> <span class="st">"node.label"</span>)</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>tree_data <span class="ot">&lt;-</span> tree_data <span class="sc">%&gt;%</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(<span class="fu">select</span>(d, Language_ID, GB193, GB133),</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">label=</span>Language_ID)</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>tree_data <span class="ot">&lt;-</span> tree_data <span class="sc">%&gt;%</span></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GB193 =</span> <span class="fu">factor</span>(GB193)) <span class="sc">%&gt;%</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GB133 =</span> <span class="fu">factor</span>(GB133))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre>Joining with `by = join_by(label)`
</pre>
</div>
</div>
</div>
<div id="cell-60" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="61">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>custom_palette <span class="ot">&lt;-</span> <span class="fu">paletteer_c</span>(<span class="st">"ggthemes::Classic Orange-Blue"</span>, <span class="dv">30</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot with two color scales</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtree</span>(pruned_tree, <span class="at">layout=</span><span class="st">"circular"</span>) <span class="sc">%&lt;+%</span> tree_data <span class="sc">+</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># First color scale for branches</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tree</span>(<span class="fu">aes</span>(<span class="at">color =</span> z_adjective)) <span class="sc">+</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradientn</span>(<span class="at">colors =</span> custom_palette) <span class="sc">+</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reset color scale</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  ggnewscale<span class="sc">::</span><span class="fu">new_scale_color</span>() <span class="sc">+</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Color tip points by a discrete or continuous variable</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tippoint</span>(<span class="fu">aes</span>(<span class="at">color =</span> GB193), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"1"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"2"</span> <span class="ot">=</span> <span class="st">"blue"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="phylogenetic_OU_regression_files/figure-html/cell-40-output-1.png" width="720" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-61" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="62">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtree</span>(pruned_tree, <span class="at">layout =</span> <span class="st">"circular"</span>) <span class="sc">%&lt;+%</span> tree_data <span class="sc">+</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># First color scale for branches</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tree</span>(<span class="fu">aes</span>(<span class="at">color =</span> z_vo)) <span class="sc">+</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradientn</span>(<span class="at">colors =</span> custom_palette) <span class="sc">+</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reset color scale</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  ggnewscale<span class="sc">::</span><span class="fu">new_scale_color</span>() <span class="sc">+</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Color tip points by a discrete or continuous variable</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tippoint</span>(<span class="fu">aes</span>(<span class="at">color =</span> GB133), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"0"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"1"</span> <span class="ot">=</span> <span class="st">"blue"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="phylogenetic_OU_regression_files/figure-html/cell-41-output-1.png" width="720" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Another advantage of this approach (both the regression and the correlation variant) is that it can easily be combined with family-level or macroarea-level random effects. Also, geographic random effects can easily be added.</p>
<p>More details can be found in my arxiv paper <em>Computational Tyology</em> (https://arxiv.org/abs/2504.15642)</p>
</section>
<section id="pagel-meade-style-test-for-correlation" class="level2">
<h2 class="anchored" data-anchor-id="pagel-meade-style-test-for-correlation">Pagel &amp; Meade style test for correlation</h2>
<p>The test for correlation using CTMC, as developed by Pagel &amp; Meade (2006) and implemented in BayesTraits, can also be implemented in Stan, using Felsenstein’s pruning algorithm.</p>
<div id="cell-63" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>stan_modelcode_ctmc_independent <span class="ot">=</span> <span class="st">"</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N;                                     // number of tips with data</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; Nnodes;                                // total number of nodes</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; Nedges;                                // number of edges in the tree</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0, upper=1&gt; x;                   // first variable</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0, upper=1&gt; y;                   // second variable</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="st">  array[Nedges, 2] int&lt;lower=1, upper=Nnodes&gt; edges;  // parent → child</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[Nedges] edge_lengths;               // edge lengths</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1, upper=Nnodes&gt; root_node;               // index of root node</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="st">// parameters of the CTMCs</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] rates;</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="st">  simplex[2] pi_1;</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="st">  simplex[2] pi_2;</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="st">  // Q matrices</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[2, 2] Q1;</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[2, 2] Q2;</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="st">  Q1[1,1] = -rates[1] * pi_1[2];</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="st">  Q1[1,2] =  rates[1] * pi_1[2];</span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a><span class="st">  Q1[2,1] =  rates[1] * pi_1[1];</span></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a><span class="st">  Q1[2,2] = -rates[1] * pi_1[1];</span></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a><span class="st">  Q2[1,1] = -rates[2] * pi_2[2];</span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a><span class="st">  Q2[1,2] =  rates[2] * pi_2[2];</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a><span class="st">  Q2[2,1] =  rates[2] * pi_2[1];</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a><span class="st">  Q2[2,2] = -rates[2] * pi_2[1];</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a><span class="st">  // matrices for Felsenstein recursion</span></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Nnodes, 2] loglikelihood_x;</span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Nnodes, 2] loglikelihood_y;</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a><span class="st">  // initialize loglikelihood matrices with log(0)</span></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:Nnodes) {</span></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a><span class="st">    loglikelihood_x[n] = rep_row_vector(negative_infinity(), 2);</span></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a><span class="st">    loglikelihood_y[n] = rep_row_vector(negative_infinity(), 2);</span></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a><span class="st">  // set the loglikelihoods for the tips</span></span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a><span class="st">    loglikelihood_x[i, x[i] + 1] = 0;</span></span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a><span class="st">    loglikelihood_y[i, y[i] + 1] = 0;</span></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a><span class="st">  // recursive computation of loglikelihoods</span></span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a><span class="st">  for (e in 1:Nedges) {</span></span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a><span class="st">    int parent = edges[e, 1];</span></span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a><span class="st">    int child = edges[e, 2];</span></span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a><span class="st">    real t = edge_lengths[e];</span></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a><span class="st">    matrix[2,2] P1 = matrix_exp(Q1 * t);</span></span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a><span class="st">    matrix[2,2] P2 = matrix_exp(Q2 * t);</span></span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a><span class="st">    for (k in 1:2) {</span></span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a><span class="st">      loglikelihood_x[parent, k] = log_sum_exp(to_vector(log(P1[k]) + loglikelihood_x[child]));</span></span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a><span class="st">      loglikelihood_y[parent, k] = log_sum_exp(to_vector(log(P2[k]) + loglikelihood_y[child]));</span></span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a><span class="st">  rates ~ lognormal(-1, 0.5);</span></span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a><span class="st">  pi_1 ~ dirichlet(rep_vector(2, 2));</span></span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a><span class="st">  pi_2 ~ dirichlet(rep_vector(2, 2));</span></span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a><span class="st">  target += log_sum_exp(loglikelihood_x[root_node] + log(pi_1)');</span></span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a><span class="st">  target += log_sum_exp(loglikelihood_y[root_node] + log(pi_2)');</span></span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-76"><a href="#cb53-76" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities { // compute log p(x_i|x_{-i}, y, theta) and log p(y_i| x, y_{-i}, theta) for each i</span></span>
<span id="cb53-77"><a href="#cb53-77" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] x_log_lik;</span></span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] y_log_lik;</span></span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a><span class="st">  {</span></span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a><span class="st">    matrix[Nnodes, 2] ll_x;</span></span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a><span class="st">    matrix[Nnodes, 2] ll_y;</span></span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a><span class="st">    for (i in 1:N) {</span></span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a><span class="st">      // initialize with log(0)</span></span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a><span class="st">      for (n in 1:Nnodes) {</span></span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a><span class="st">        ll_x[n] = rep_row_vector(negative_infinity(), 2);</span></span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a><span class="st">        ll_y[n] = rep_row_vector(negative_infinity(), 2);</span></span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb53-90"><a href="#cb53-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-91"><a href="#cb53-91" aria-hidden="true" tabindex="-1"></a><span class="st">      // flip x[i] and y[i]</span></span>
<span id="cb53-92"><a href="#cb53-92" aria-hidden="true" tabindex="-1"></a><span class="st">      for (j in 1:N) {</span></span>
<span id="cb53-93"><a href="#cb53-93" aria-hidden="true" tabindex="-1"></a><span class="st">        int xj = (j == i) ? 1 - x[j] : x[j];</span></span>
<span id="cb53-94"><a href="#cb53-94" aria-hidden="true" tabindex="-1"></a><span class="st">        int yj = (j == i) ? 1 - y[j] : y[j];</span></span>
<span id="cb53-95"><a href="#cb53-95" aria-hidden="true" tabindex="-1"></a><span class="st">        ll_x[j, xj + 1] = 0;</span></span>
<span id="cb53-96"><a href="#cb53-96" aria-hidden="true" tabindex="-1"></a><span class="st">        ll_y[j, yj + 1] = 0;</span></span>
<span id="cb53-97"><a href="#cb53-97" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb53-98"><a href="#cb53-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-99"><a href="#cb53-99" aria-hidden="true" tabindex="-1"></a><span class="st">      // recurse up the tree</span></span>
<span id="cb53-100"><a href="#cb53-100" aria-hidden="true" tabindex="-1"></a><span class="st">      for (e in 1:Nedges) {</span></span>
<span id="cb53-101"><a href="#cb53-101" aria-hidden="true" tabindex="-1"></a><span class="st">        int parent = edges[e, 1];</span></span>
<span id="cb53-102"><a href="#cb53-102" aria-hidden="true" tabindex="-1"></a><span class="st">        int child = edges[e, 2];</span></span>
<span id="cb53-103"><a href="#cb53-103" aria-hidden="true" tabindex="-1"></a><span class="st">        real t = edge_lengths[e];</span></span>
<span id="cb53-104"><a href="#cb53-104" aria-hidden="true" tabindex="-1"></a><span class="st">        matrix[2,2] P1 = matrix_exp(Q1 * t);</span></span>
<span id="cb53-105"><a href="#cb53-105" aria-hidden="true" tabindex="-1"></a><span class="st">        matrix[2,2] P2 = matrix_exp(Q2 * t);</span></span>
<span id="cb53-106"><a href="#cb53-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-107"><a href="#cb53-107" aria-hidden="true" tabindex="-1"></a><span class="st">        for (k in 1:2) {</span></span>
<span id="cb53-108"><a href="#cb53-108" aria-hidden="true" tabindex="-1"></a><span class="st">          ll_x[parent, k] = log_sum_exp(to_vector(log(P1[k]) + ll_x[child]));</span></span>
<span id="cb53-109"><a href="#cb53-109" aria-hidden="true" tabindex="-1"></a><span class="st">          ll_y[parent, k] = log_sum_exp(to_vector(log(P2[k]) + ll_y[child]));</span></span>
<span id="cb53-110"><a href="#cb53-110" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb53-111"><a href="#cb53-111" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb53-112"><a href="#cb53-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-113"><a href="#cb53-113" aria-hidden="true" tabindex="-1"></a><span class="st">      real full_loglik_x = log_sum_exp(loglikelihood_x[root_node] + log(pi_1)');</span></span>
<span id="cb53-114"><a href="#cb53-114" aria-hidden="true" tabindex="-1"></a><span class="st">      real flip_loglik_x = log_sum_exp(ll_x[root_node] + log(pi_1)');</span></span>
<span id="cb53-115"><a href="#cb53-115" aria-hidden="true" tabindex="-1"></a><span class="st">      x_log_lik[i] = full_loglik_x - log_sum_exp(full_loglik_x, flip_loglik_x);</span></span>
<span id="cb53-116"><a href="#cb53-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-117"><a href="#cb53-117" aria-hidden="true" tabindex="-1"></a><span class="st">      real full_loglik_y = log_sum_exp(loglikelihood_y[root_node] + log(pi_2)');</span></span>
<span id="cb53-118"><a href="#cb53-118" aria-hidden="true" tabindex="-1"></a><span class="st">      real flip_loglik_y = log_sum_exp(ll_y[root_node] + log(pi_2)');</span></span>
<span id="cb53-119"><a href="#cb53-119" aria-hidden="true" tabindex="-1"></a><span class="st">      y_log_lik[i] = full_loglik_y - log_sum_exp(full_loglik_y, flip_loglik_y);</span></span>
<span id="cb53-120"><a href="#cb53-120" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb53-121"><a href="#cb53-121" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb53-122"><a href="#cb53-122" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb53-123"><a href="#cb53-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-124"><a href="#cb53-124" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb53-125"><a href="#cb53-125" aria-hidden="true" tabindex="-1"></a>stan_model_ctmc_independent <span class="ot">&lt;-</span> <span class="fu">stan_model</span>(<span class="at">model_code=</span>stan_modelcode_ctmc_independent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-64" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="69">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>fit_ctmc_independent <span class="ot">&lt;-</span> <span class="fu">sampling</span>(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    stan_model_ctmc_independent,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> stan_data,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-65" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="70">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit_ctmc_independent, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">"pi_1"</span>, <span class="st">"pi_2"</span>, <span class="st">"rates"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

         mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat
pi_1[1]  0.39       0 0.20 0.07 0.24 0.38 0.53  0.81  4648    1
pi_1[2]  0.61       0 0.20 0.19 0.47 0.62 0.76  0.93  4648    1
pi_2[1]  0.60       0 0.20 0.18 0.46 0.62 0.75  0.94  4511    1
pi_2[2]  0.40       0 0.20 0.06 0.25 0.38 0.54  0.82  4511    1
rates[1] 0.41       0 0.22 0.14 0.26 0.37 0.51  0.97  3854    1
rates[2] 0.41       0 0.22 0.14 0.26 0.37 0.51  0.98  4118    1

Samples were drawn using NUTS(diag_e) at Sat Jun 14 20:26:19 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<div id="cell-66" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="71">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">capture.output</span>({</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    log_marginal_likelihood_ctmc_independent <span class="ot">&lt;-</span> <span class="fu">bridge_sampler</span>(fit_ctmc_independent)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>}, <span class="at">file =</span> <span class="st">"/dev/null"</span>)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(log_marginal_likelihood_ctmc_independent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bridge sampling estimate of the log marginal likelihood: -6.36208
Estimate obtained in 5 iteration(s) via method "normal".</code></pre>
</div>
</div>
<div id="cell-67" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="78">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>stan_modelcode_ctmc_dependent <span class="ot">=</span> <span class="st">"</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="st">functions {</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="st">  vector stationary_distribution(matrix Q) {</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="st">    int K = rows(Q);</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="st">    matrix[K, K] A = Q';</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[K] b = rep_vector(0.0, K);</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="st">    // Replace one row by sum-to-one constraint</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="st">    A[K] = rep_row_vector(1.0, K);</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="st">    b[K] = 1.0;</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="st">    return mdivide_left(A, b);  // solve A * pi = b</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N;</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; Nnodes;</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; Nedges;</span></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0, upper=1&gt; x;</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0, upper=1&gt; y;</span></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a><span class="st">  array[Nedges, 2] int&lt;lower=1, upper=Nnodes&gt; edges;</span></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[Nedges] edge_lengths;</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1, upper=Nnodes&gt; root_node;</span></span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a><span class="st">transformed data {</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a><span class="st">   array[N] int z;</span></span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a><span class="st">   for (i in 1:N) {</span></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a><span class="st">      z[i] = 2* x[i] + y[i];</span></span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a><span class="st">   }</span></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; total_rate;</span></span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a><span class="st">  simplex[8] rates;</span></span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a><span class="st">  // Q matrices</span></span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[4, 4] Q;</span></span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[1,1] = -rates[1] - rates[2];</span></span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[1,2] = rates[1];</span></span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[1,3] = rates[2];</span></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[1,4] = 0;</span></span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[2,1] = rates[3];</span></span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[2,2] = -rates[3] - rates[4];</span></span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[2,3] = 0;</span></span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[2,4] = rates[4];</span></span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[3,1] = rates[5];</span></span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[3,2] = 0;</span></span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[3,3] = -rates[5] - rates[6];</span></span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[3,4] = rates[6];</span></span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[4,1] = 0;</span></span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[4,2] = rates[7];</span></span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[4,3] = rates[8];</span></span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a><span class="st">  Q[4,4] = -rates[7] - rates[8];</span></span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true" tabindex="-1"></a><span class="st">  Q = total_rate * Q;</span></span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[4] pi = stationary_distribution(Q);</span></span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Nnodes, 4] loglikelihood;</span></span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:Nnodes) {</span></span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true" tabindex="-1"></a><span class="st">    loglikelihood[n] = rep_row_vector(negative_infinity(), 4);</span></span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb59-70"><a href="#cb59-70" aria-hidden="true" tabindex="-1"></a><span class="st">    loglikelihood[i, z[i] + 1] = 0;</span></span>
<span id="cb59-71"><a href="#cb59-71" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb59-72"><a href="#cb59-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-73"><a href="#cb59-73" aria-hidden="true" tabindex="-1"></a><span class="st">  for (e in 1:Nedges) {</span></span>
<span id="cb59-74"><a href="#cb59-74" aria-hidden="true" tabindex="-1"></a><span class="st">    int parent = edges[e, 1];</span></span>
<span id="cb59-75"><a href="#cb59-75" aria-hidden="true" tabindex="-1"></a><span class="st">    int child = edges[e, 2];</span></span>
<span id="cb59-76"><a href="#cb59-76" aria-hidden="true" tabindex="-1"></a><span class="st">    real t = edge_lengths[e];</span></span>
<span id="cb59-77"><a href="#cb59-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-78"><a href="#cb59-78" aria-hidden="true" tabindex="-1"></a><span class="st">    matrix[4,4] P = matrix_exp(Q * t);</span></span>
<span id="cb59-79"><a href="#cb59-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-80"><a href="#cb59-80" aria-hidden="true" tabindex="-1"></a><span class="st">    for (k in 1:4) {</span></span>
<span id="cb59-81"><a href="#cb59-81" aria-hidden="true" tabindex="-1"></a><span class="st">      loglikelihood[parent, k] = log_sum_exp(to_vector(log(P[k]) + loglikelihood[child]));</span></span>
<span id="cb59-82"><a href="#cb59-82" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb59-83"><a href="#cb59-83" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb59-84"><a href="#cb59-84" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb59-85"><a href="#cb59-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-86"><a href="#cb59-86" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb59-87"><a href="#cb59-87" aria-hidden="true" tabindex="-1"></a><span class="st">  total_rate ~ gamma(1, 1);</span></span>
<span id="cb59-88"><a href="#cb59-88" aria-hidden="true" tabindex="-1"></a><span class="st">  rates ~ dirichlet(rep_vector(1, 8));</span></span>
<span id="cb59-89"><a href="#cb59-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-90"><a href="#cb59-90" aria-hidden="true" tabindex="-1"></a><span class="st">  target += log_sum_exp(loglikelihood[root_node] + log(pi)');</span></span>
<span id="cb59-91"><a href="#cb59-91" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb59-92"><a href="#cb59-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-93"><a href="#cb59-93" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb59-94"><a href="#cb59-94" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] x_log_lik;</span></span>
<span id="cb59-95"><a href="#cb59-95" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] y_log_lik;</span></span>
<span id="cb59-96"><a href="#cb59-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-97"><a href="#cb59-97" aria-hidden="true" tabindex="-1"></a><span class="st">  {</span></span>
<span id="cb59-98"><a href="#cb59-98" aria-hidden="true" tabindex="-1"></a><span class="st">    matrix[Nnodes, 4] ll;</span></span>
<span id="cb59-99"><a href="#cb59-99" aria-hidden="true" tabindex="-1"></a><span class="st">    real loglik;</span></span>
<span id="cb59-100"><a href="#cb59-100" aria-hidden="true" tabindex="-1"></a><span class="st">    real loglik_flipped;</span></span>
<span id="cb59-101"><a href="#cb59-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-102"><a href="#cb59-102" aria-hidden="true" tabindex="-1"></a><span class="st">    for (i in 1:N) {</span></span>
<span id="cb59-103"><a href="#cb59-103" aria-hidden="true" tabindex="-1"></a><span class="st">      // --- FULL loglikelihood ---</span></span>
<span id="cb59-104"><a href="#cb59-104" aria-hidden="true" tabindex="-1"></a><span class="st">      for (n in 1:Nnodes)</span></span>
<span id="cb59-105"><a href="#cb59-105" aria-hidden="true" tabindex="-1"></a><span class="st">        ll[n] = rep_row_vector(negative_infinity(), 4);</span></span>
<span id="cb59-106"><a href="#cb59-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-107"><a href="#cb59-107" aria-hidden="true" tabindex="-1"></a><span class="st">      for (j in 1:N)</span></span>
<span id="cb59-108"><a href="#cb59-108" aria-hidden="true" tabindex="-1"></a><span class="st">        ll[j, z[j] + 1] = 0;</span></span>
<span id="cb59-109"><a href="#cb59-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-110"><a href="#cb59-110" aria-hidden="true" tabindex="-1"></a><span class="st">      for (e in 1:Nedges) {</span></span>
<span id="cb59-111"><a href="#cb59-111" aria-hidden="true" tabindex="-1"></a><span class="st">        int parent = edges[e, 1];</span></span>
<span id="cb59-112"><a href="#cb59-112" aria-hidden="true" tabindex="-1"></a><span class="st">        int child  = edges[e, 2];</span></span>
<span id="cb59-113"><a href="#cb59-113" aria-hidden="true" tabindex="-1"></a><span class="st">        real t = edge_lengths[e];</span></span>
<span id="cb59-114"><a href="#cb59-114" aria-hidden="true" tabindex="-1"></a><span class="st">        matrix[4,4] P = matrix_exp(Q * t);</span></span>
<span id="cb59-115"><a href="#cb59-115" aria-hidden="true" tabindex="-1"></a><span class="st">        for (k in 1:4)</span></span>
<span id="cb59-116"><a href="#cb59-116" aria-hidden="true" tabindex="-1"></a><span class="st">          ll[parent, k] = log_sum_exp(to_vector(log(P[k]) + ll[child]));</span></span>
<span id="cb59-117"><a href="#cb59-117" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb59-118"><a href="#cb59-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-119"><a href="#cb59-119" aria-hidden="true" tabindex="-1"></a><span class="st">      loglik = log_sum_exp(ll[root_node] + log(pi)');</span></span>
<span id="cb59-120"><a href="#cb59-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-121"><a href="#cb59-121" aria-hidden="true" tabindex="-1"></a><span class="st">      // --- x_i flipped ---</span></span>
<span id="cb59-122"><a href="#cb59-122" aria-hidden="true" tabindex="-1"></a><span class="st">      for (n in 1:Nnodes)</span></span>
<span id="cb59-123"><a href="#cb59-123" aria-hidden="true" tabindex="-1"></a><span class="st">        ll[n] = rep_row_vector(negative_infinity(), 4);</span></span>
<span id="cb59-124"><a href="#cb59-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-125"><a href="#cb59-125" aria-hidden="true" tabindex="-1"></a><span class="st">      for (j in 1:N) {</span></span>
<span id="cb59-126"><a href="#cb59-126" aria-hidden="true" tabindex="-1"></a><span class="st">        int zj = z[j];</span></span>
<span id="cb59-127"><a href="#cb59-127" aria-hidden="true" tabindex="-1"></a><span class="st">        if (j == i) {</span></span>
<span id="cb59-128"><a href="#cb59-128" aria-hidden="true" tabindex="-1"></a><span class="st">          // flip x but keep y</span></span>
<span id="cb59-129"><a href="#cb59-129" aria-hidden="true" tabindex="-1"></a><span class="st">          if (zj == 0) zj = 2;</span></span>
<span id="cb59-130"><a href="#cb59-130" aria-hidden="true" tabindex="-1"></a><span class="st">          else if (zj == 1) zj = 3;</span></span>
<span id="cb59-131"><a href="#cb59-131" aria-hidden="true" tabindex="-1"></a><span class="st">          else if (zj == 2) zj = 0;</span></span>
<span id="cb59-132"><a href="#cb59-132" aria-hidden="true" tabindex="-1"></a><span class="st">          else if (zj == 3) zj = 1;</span></span>
<span id="cb59-133"><a href="#cb59-133" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb59-134"><a href="#cb59-134" aria-hidden="true" tabindex="-1"></a><span class="st">        ll[j, zj + 1] = 0;</span></span>
<span id="cb59-135"><a href="#cb59-135" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb59-136"><a href="#cb59-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-137"><a href="#cb59-137" aria-hidden="true" tabindex="-1"></a><span class="st">      for (e in 1:Nedges) {</span></span>
<span id="cb59-138"><a href="#cb59-138" aria-hidden="true" tabindex="-1"></a><span class="st">        int parent = edges[e, 1];</span></span>
<span id="cb59-139"><a href="#cb59-139" aria-hidden="true" tabindex="-1"></a><span class="st">        int child  = edges[e, 2];</span></span>
<span id="cb59-140"><a href="#cb59-140" aria-hidden="true" tabindex="-1"></a><span class="st">        real t = edge_lengths[e];</span></span>
<span id="cb59-141"><a href="#cb59-141" aria-hidden="true" tabindex="-1"></a><span class="st">        matrix[4,4] P = matrix_exp(Q * t);</span></span>
<span id="cb59-142"><a href="#cb59-142" aria-hidden="true" tabindex="-1"></a><span class="st">        for (k in 1:4)</span></span>
<span id="cb59-143"><a href="#cb59-143" aria-hidden="true" tabindex="-1"></a><span class="st">          ll[parent, k] = log_sum_exp(to_vector(log(P[k]) + ll[child]));</span></span>
<span id="cb59-144"><a href="#cb59-144" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb59-145"><a href="#cb59-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-146"><a href="#cb59-146" aria-hidden="true" tabindex="-1"></a><span class="st">      loglik_flipped = log_sum_exp(ll[root_node] + log(pi)');</span></span>
<span id="cb59-147"><a href="#cb59-147" aria-hidden="true" tabindex="-1"></a><span class="st">      x_log_lik[i] = loglik - log_sum_exp([loglik, loglik_flipped]');</span></span>
<span id="cb59-148"><a href="#cb59-148" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb59-149"><a href="#cb59-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-150"><a href="#cb59-150" aria-hidden="true" tabindex="-1"></a><span class="st">    // Now repeat the same for y</span></span>
<span id="cb59-151"><a href="#cb59-151" aria-hidden="true" tabindex="-1"></a><span class="st">    for (i in 1:N) {</span></span>
<span id="cb59-152"><a href="#cb59-152" aria-hidden="true" tabindex="-1"></a><span class="st">      for (n in 1:Nnodes)</span></span>
<span id="cb59-153"><a href="#cb59-153" aria-hidden="true" tabindex="-1"></a><span class="st">        ll[n] = rep_row_vector(negative_infinity(), 4);</span></span>
<span id="cb59-154"><a href="#cb59-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-155"><a href="#cb59-155" aria-hidden="true" tabindex="-1"></a><span class="st">      for (j in 1:N)</span></span>
<span id="cb59-156"><a href="#cb59-156" aria-hidden="true" tabindex="-1"></a><span class="st">        ll[j, z[j] + 1] = 0;</span></span>
<span id="cb59-157"><a href="#cb59-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-158"><a href="#cb59-158" aria-hidden="true" tabindex="-1"></a><span class="st">      for (e in 1:Nedges) {</span></span>
<span id="cb59-159"><a href="#cb59-159" aria-hidden="true" tabindex="-1"></a><span class="st">        int parent = edges[e, 1];</span></span>
<span id="cb59-160"><a href="#cb59-160" aria-hidden="true" tabindex="-1"></a><span class="st">        int child  = edges[e, 2];</span></span>
<span id="cb59-161"><a href="#cb59-161" aria-hidden="true" tabindex="-1"></a><span class="st">        real t = edge_lengths[e];</span></span>
<span id="cb59-162"><a href="#cb59-162" aria-hidden="true" tabindex="-1"></a><span class="st">        matrix[4,4] P = matrix_exp(Q * t);</span></span>
<span id="cb59-163"><a href="#cb59-163" aria-hidden="true" tabindex="-1"></a><span class="st">        for (k in 1:4)</span></span>
<span id="cb59-164"><a href="#cb59-164" aria-hidden="true" tabindex="-1"></a><span class="st">          ll[parent, k] = log_sum_exp(to_vector(log(P[k]) + ll[child]));</span></span>
<span id="cb59-165"><a href="#cb59-165" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb59-166"><a href="#cb59-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-167"><a href="#cb59-167" aria-hidden="true" tabindex="-1"></a><span class="st">      loglik = log_sum_exp(ll[root_node] + log(pi)');</span></span>
<span id="cb59-168"><a href="#cb59-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-169"><a href="#cb59-169" aria-hidden="true" tabindex="-1"></a><span class="st">      for (n in 1:Nnodes)</span></span>
<span id="cb59-170"><a href="#cb59-170" aria-hidden="true" tabindex="-1"></a><span class="st">        ll[n] = rep_row_vector(negative_infinity(), 4);</span></span>
<span id="cb59-171"><a href="#cb59-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-172"><a href="#cb59-172" aria-hidden="true" tabindex="-1"></a><span class="st">      for (j in 1:N) {</span></span>
<span id="cb59-173"><a href="#cb59-173" aria-hidden="true" tabindex="-1"></a><span class="st">        int zj = z[j];</span></span>
<span id="cb59-174"><a href="#cb59-174" aria-hidden="true" tabindex="-1"></a><span class="st">        if (j == i) {</span></span>
<span id="cb59-175"><a href="#cb59-175" aria-hidden="true" tabindex="-1"></a><span class="st">          // flip y but keep x</span></span>
<span id="cb59-176"><a href="#cb59-176" aria-hidden="true" tabindex="-1"></a><span class="st">          if (zj == 0) zj = 1;</span></span>
<span id="cb59-177"><a href="#cb59-177" aria-hidden="true" tabindex="-1"></a><span class="st">          else if (zj == 1) zj = 0;</span></span>
<span id="cb59-178"><a href="#cb59-178" aria-hidden="true" tabindex="-1"></a><span class="st">          else if (zj == 2) zj = 3;</span></span>
<span id="cb59-179"><a href="#cb59-179" aria-hidden="true" tabindex="-1"></a><span class="st">          else if (zj == 3) zj = 2;</span></span>
<span id="cb59-180"><a href="#cb59-180" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb59-181"><a href="#cb59-181" aria-hidden="true" tabindex="-1"></a><span class="st">        ll[j, zj + 1] = 0;</span></span>
<span id="cb59-182"><a href="#cb59-182" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb59-183"><a href="#cb59-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-184"><a href="#cb59-184" aria-hidden="true" tabindex="-1"></a><span class="st">      for (e in 1:Nedges) {</span></span>
<span id="cb59-185"><a href="#cb59-185" aria-hidden="true" tabindex="-1"></a><span class="st">        int parent = edges[e, 1];</span></span>
<span id="cb59-186"><a href="#cb59-186" aria-hidden="true" tabindex="-1"></a><span class="st">        int child  = edges[e, 2];</span></span>
<span id="cb59-187"><a href="#cb59-187" aria-hidden="true" tabindex="-1"></a><span class="st">        real t = edge_lengths[e];</span></span>
<span id="cb59-188"><a href="#cb59-188" aria-hidden="true" tabindex="-1"></a><span class="st">        matrix[4,4] P = matrix_exp(Q * t);</span></span>
<span id="cb59-189"><a href="#cb59-189" aria-hidden="true" tabindex="-1"></a><span class="st">        for (k in 1:4)</span></span>
<span id="cb59-190"><a href="#cb59-190" aria-hidden="true" tabindex="-1"></a><span class="st">          ll[parent, k] = log_sum_exp(to_vector(log(P[k]) + ll[child]));</span></span>
<span id="cb59-191"><a href="#cb59-191" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb59-192"><a href="#cb59-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-193"><a href="#cb59-193" aria-hidden="true" tabindex="-1"></a><span class="st">      loglik_flipped = log_sum_exp(ll[root_node] + log(pi)');</span></span>
<span id="cb59-194"><a href="#cb59-194" aria-hidden="true" tabindex="-1"></a><span class="st">      y_log_lik[i] = loglik - log_sum_exp([loglik, loglik_flipped]');</span></span>
<span id="cb59-195"><a href="#cb59-195" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb59-196"><a href="#cb59-196" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb59-197"><a href="#cb59-197" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb59-198"><a href="#cb59-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-199"><a href="#cb59-199" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb59-200"><a href="#cb59-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-201"><a href="#cb59-201" aria-hidden="true" tabindex="-1"></a>stan_model_ctmc_dependent <span class="ot">&lt;-</span> <span class="fu">stan_model</span>(<span class="at">model_code=</span>stan_modelcode_ctmc_dependent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-68" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="79">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>fit_ctmc_dependent <span class="ot">&lt;-</span> <span class="fu">sampling</span>(</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    stan_model_ctmc_dependent,</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> stan_data,</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-69" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="80">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit_ctmc_dependent, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">"total_rate"</span>, <span class="st">"rates"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat
total_rate 0.99    0.01 0.99 0.03 0.29 0.69 1.38  3.62  5381    1
rates[1]   0.12    0.00 0.11 0.00 0.04 0.08 0.17  0.39  5508    1
rates[2]   0.16    0.00 0.12 0.01 0.07 0.13 0.22  0.44  6555    1
rates[3]   0.14    0.00 0.11 0.00 0.05 0.11 0.20  0.43  5527    1
rates[4]   0.14    0.00 0.12 0.00 0.05 0.10 0.20  0.43  5108    1
rates[5]   0.09    0.00 0.08 0.00 0.03 0.06 0.13  0.31  4992    1
rates[6]   0.09    0.00 0.09 0.00 0.02 0.06 0.12  0.32  5534    1
rates[7]   0.12    0.00 0.11 0.00 0.04 0.09 0.17  0.41  3976    1
rates[8]   0.16    0.00 0.12 0.01 0.07 0.13 0.22  0.46  4514    1

Samples were drawn using NUTS(diag_e) at Sat Jun 14 20:48:10 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<div id="cell-70" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="81">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">capture.output</span>({</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    log_marginal_likelihood_ctmc_dependent <span class="ot">&lt;-</span> <span class="fu">bridge_sampler</span>(fit_ctmc_dependent)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>}, <span class="at">file =</span> <span class="st">"/dev/null"</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(log_marginal_likelihood_ctmc_dependent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bridge sampling estimate of the log marginal likelihood: -9.90908
Estimate obtained in 6 iteration(s) via method "normal".</code></pre>
</div>
</div>
<p>And now the Bayes Factor:</p>
<div id="cell-72" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="82">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>(log_marginal_likelihood_ctmc_independent<span class="sc">$</span>logml <span class="sc">-</span> log_marginal_likelihood_ctmc_dependent<span class="sc">$</span>logml)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
3.54700302525836
</div>
</div>
<p>So we find moderate evidence in favor of the independent model.</p>
<p>In this connection it is worth pointing out that the OU/logistic model provides a massively better fit than the CTMC model.</p>
<div id="cell-74" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="83">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>(log_marginal_likelihood_OU_correlation<span class="sc">$</span>logml <span class="sc">-</span> log_marginal_likelihood_ctmc_independent<span class="sc">$</span>logml)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
264.683886213642
</div>
</div>
<p>This is reinforced by model comparison via Pareto-smoothed leave-one-out cross-validation.</p>
<div id="cell-76" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="88">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract log-likelihood matrix: draws x observations</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>log_lik5 <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(fit_ctmc_independent, <span class="at">parameter_name =</span> <span class="st">"y_log_lik"</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>log_lik6 <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(fit_ctmc_dependent, <span class="at">parameter_name =</span> <span class="st">"y_log_lik"</span>)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="co"># compute LOO</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>loo5 <span class="ot">&lt;-</span> <span class="fu">loo</span>(log_lik5)</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>loo6 <span class="ot">&lt;-</span> <span class="fu">loo</span>(log_lik6)</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="co"># compare</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(loo1, loo2, loo3, loo4, loo5, loo6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.
”</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R_zmq_msg_send errno: 4 strerror: Interrupted system call
R_zmq_msg_send errno: 4 strerror: Interrupted system call
R_zmq_msg_send errno: 4 strerror: Interrupted system call</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.
”</code></pre>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A compare.loo: 6 × 8 of type dbl</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">elpd_diff</th>
<th data-quarto-table-cell-role="th" scope="col">se_diff</th>
<th data-quarto-table-cell-role="th" scope="col">elpd_loo</th>
<th data-quarto-table-cell-role="th" scope="col">se_elpd_loo</th>
<th data-quarto-table-cell-role="th" scope="col">p_loo</th>
<th data-quarto-table-cell-role="th" scope="col">se_p_loo</th>
<th data-quarto-table-cell-role="th" scope="col">looic</th>
<th data-quarto-table-cell-role="th" scope="col">se_looic</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">model3</td>
<td>0.000000</td>
<td>0.000000</td>
<td>-21.76012</td>
<td>2.301217539</td>
<td>17.1093938</td>
<td>1.9788649</td>
<td>43.52024</td>
<td>4.60243508</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">model4</td>
<td>-7.389789</td>
<td>1.179653</td>
<td>-29.14991</td>
<td>3.197381229</td>
<td>21.3001107</td>
<td>2.6327950</td>
<td>58.29982</td>
<td>6.39476246</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">model1</td>
<td>-44.524619</td>
<td>3.102177</td>
<td>-66.28474</td>
<td>3.308107454</td>
<td>2.1827108</td>
<td>0.1591767</td>
<td>132.56948</td>
<td>6.61621491</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">model2</td>
<td>-45.127532</td>
<td>2.562491</td>
<td>-66.88765</td>
<td>2.359000311</td>
<td>15.8129234</td>
<td>0.7208897</td>
<td>133.77531</td>
<td>4.71800062</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">model6</td>
<td>-47.548270</td>
<td>2.301414</td>
<td>-69.30839</td>
<td>0.006327375</td>
<td>0.2474160</td>
<td>0.2474160</td>
<td>138.61678</td>
<td>0.01265475</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">model5</td>
<td>-47.571537</td>
<td>2.300777</td>
<td>-69.33166</td>
<td>0.016939997</td>
<td>0.2014436</td>
<td>0.2014436</td>
<td>138.66332</td>
<td>0.03387999</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>All the models discussed here use a single phylogeny. It is possible to use a sample of phylogenies to factor in phylogenetic uncertainty in this framework, but it makes the models more complex and the fitting computationally more demanding.</p>
<p>Essentially, what you have to do is:</p>
<ul>
<li><p>Construct a 3-dimensional <code>edge</code> array (number of edges <span class="math inline">\(\times\)</span> 2 <span class="math inline">\(\times\)</span> number of trees), where each layer <code>edge[i,j,k]</code> indicates that there is a branch from node <code>i</code> to node <code>j</code> in tree number <code>k</code>. You have to make sure that all trees are in postorder.</p></li>
<li><p>Construct a number of edges <span class="math inline">\(\times\)</span> number of trees matrix <code>edge_lengths</code></p></li>
<li><p>In the Stan model, you have to loop over all edges in all trees. So the phylogenetic recursion should look like</p></li>
</ul>
<pre class="{stan}"><code>for (tr in 1:Ntrees) {
    for (e in 1:Nedges) {
        int parent = edges[e, 1, tr];
        int child = edges[e, 2, tr];
        real t = edge_lengths[e, tr];
        ...
    }
}</code></pre>
<ul>
<li>Inside the model block, add the line</li>
</ul>
<pre class="{stan}"><code>target -= log(Ntrees);</code></pre>
<p>Together, this averages over the likelihoods of all trees in the tree sample. Since the likelihoods of all trees in the sample have to be computed, this will slow down model fitting quite a bit.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>